name: Backend CI/CD

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'backend/**'
      - 'gradlew'
      - 'gradlew.bat'
      - 'build.gradle'
      - 'settings.gradle'
      - 'gradle/**'
      - 'Dockerfile'
      - '.github/workflows/backend-ci.yml'

jobs:
  # Build and Test Backend
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew clean build -x test

      #    - name: Run Tests with Kover
      #      # ÌÖåÏä§Ìä∏Î•º Ïã§ÌñâÌïòÍ≥† Kover XML Î¶¨Ìè¨Ìä∏Î•º ÏÉùÏÑ±Ìï©ÎãàÎã§.
      #      run: ./gradlew koverXmlReport
      #
      #    - name: Add Coverage PR Comment
      #      # ÏÉùÏÑ±Îêú XML Î¶¨Ìè¨Ìä∏Î•º Î∂ÑÏÑùÌïòÏó¨ Pull RequestÏóê Ïª§Î≤ÑÎ¶¨ÏßÄ ÏßÄÌëúÎ•º ÎåìÍ∏ÄÎ°ú ÎÇ®ÍπÅÎãàÎã§.
      #      uses: madrapps/jacoco-report@v1.6.1
      #      if: github.event_name == 'pull_request'
      #      with:
      #        # KoverÍ∞Ä ÏÉùÏÑ±Ìïú XML Î¶¨Ìè¨Ìä∏ ÌååÏùº Í≤ΩÎ°ú (build.gradle.kts ÏÑ§Ï†ïÍ≥º ÏùºÏπòÌï¥Ïïº Ìï®)
      #        paths: build/reports/kover/report.xml
      #        # PRÏóê ÎåìÍ∏ÄÏùÑ Îã¨Í∏∞ ÏúÑÌï¥ ÌïÑÏöîÌïú GitHub ÌÜ†ÌÅ∞ (ActionsÍ∞Ä ÏûêÎèôÏúºÎ°ú Ï†úÍ≥µ)
      #        token: ${{ secrets.GITHUB_TOKEN }}
      #        # Ï†ÑÏ≤¥ ÌîÑÎ°úÏ†ùÌä∏Ïùò ÏµúÏÜå Ïª§Î≤ÑÎ¶¨ÏßÄ Í∏∞Ï§Ä (0Ïù¥Î©¥ Ïã§Ìå®ÏãúÌÇ§ÏßÄ ÏïäÏùå)
      #        min-coverage-overall: 0
      #        # Î≥ÄÍ≤ΩÎêú ÌååÏùºÏùò ÏµúÏÜå Ïª§Î≤ÑÎ¶¨ÏßÄ Í∏∞Ï§Ä (0Ïù¥Î©¥ Ïã§Ìå®ÏãúÌÇ§ÏßÄ ÏïäÏùå)
      #        min-coverage-changed-files: 0
      #        # PR ÎåìÍ∏ÄÏóê ÌëúÏãúÎê† Î¶¨Ìè¨Ìä∏ Ï†úÎ™©
      #        title: Code Coverage
      #        # Í∏∞Ï°¥ ÎåìÍ∏ÄÏù¥ ÏûàÎã§Î©¥ ÏÉàÎ°ú Îã¨ÏßÄ ÏïäÍ≥† ÏóÖÎç∞Ïù¥Ìä∏Ìï® (true: ÏóÖÎç∞Ïù¥Ìä∏, false: Îß§Î≤à ÏÉà ÎåìÍ∏Ä)
      #        update-comment: true

      - name: Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: backend-build-artifacts
          path: build/libs/*.jar
          retention-days: 7

  # Deploy Backend to Oracle Cloud
  deploy:
    runs-on: ubuntu-latest
    needs: [ build ]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Verify SSH Secrets
        run: |
          if [ -z "${{ secrets.ORACLE_CLOUD_HOST }}" ]; then
            echo "‚ùå ORACLE_CLOUD_HOST secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.ORACLE_CLOUD_USER }}" ]; then
            echo "‚ùå ORACLE_CLOUD_USER secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.ORACLE_CLOUD_SSH_KEY }}" ]; then
            echo "‚ùå ORACLE_CLOUD_SSH_KEY secret is not set"
            exit 1
          fi
          echo "‚úÖ All SSH secrets are configured"
          echo "Host: ${{ secrets.ORACLE_CLOUD_HOST }}"
          echo "User: ${{ secrets.ORACLE_CLOUD_USER }}"

      - name: Test SSH Connection
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.ORACLE_CLOUD_HOST }}
          username: ${{ secrets.ORACLE_CLOUD_USER }}
          key: ${{ secrets.ORACLE_CLOUD_SSH_KEY }}
          port: 22
          debug: true
          command_timeout: 30s
          script: |
            echo "‚úÖ SSH connection successful!"
            echo "Server: $(hostname)"
            echo "User: $(whoami)"
            echo "Working directory: $(pwd)"

      - name: Deploy Backend to Oracle Cloud
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.ORACLE_CLOUD_HOST }}
          username: ${{ secrets.ORACLE_CLOUD_USER }}
          key: ${{ secrets.ORACLE_CLOUD_SSH_KEY }}
          port: 22
          debug: true
          command_timeout: 10m
          script: |
            cd ~/planit
            git fetch origin
            git reset --hard origin/main
            
            # Stop and rebuild only backend service
            echo "üîÑ Stopping backend service..."
            docker compose --env-file .env.prod -f docker-compose.prod.yml stop backend
            docker compose --env-file .env.prod -f docker-compose.prod.yml rm -f backend
            
            echo "üèóÔ∏è  Building and starting backend service..."
            docker compose --env-file .env.prod -f docker-compose.prod.yml up -d --build backend
            
            # Check container status
            echo "üìä Container status:"
            docker compose -f docker-compose.prod.yml ps
            
            # Health check (wait up to 60 seconds)
            echo "üè• Waiting for backend to be healthy..."
            for i in {1..12}; do
              if curl -f http://localhost:8080/api/health > /dev/null 2>&1; then
                echo "‚úÖ Backend is healthy!"
                exit 0
              fi
              echo "‚è≥ Waiting... ($i/12)"
              sleep 5
            done
            
            echo "‚ùå Backend health check failed"
            docker compose -f docker-compose.prod.yml logs --tail=50 backend
            exit 1
