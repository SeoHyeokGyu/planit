# .github/workflows/project-status-monitor.yml
name: Project Status Monitor

on:
  schedule:
    # ë§¤ 10ë¶„ë§ˆë‹¤ ì‹¤í–‰ (í•„ìš”ì— ë”°ë¼ ì¡°ì •)
    - cron: '*/10 * * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

jobs:
  monitor-project:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Monitor Project Changes
        id: monitor
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // í”„ë¡œì íŠ¸ ID ì„¤ì • (í”„ë¡œì íŠ¸ URLì—ì„œ í™•ì¸ ê°€ëŠ¥)
            const PROJECT_ID = 'planit'; // ì‹¤ì œ í”„ë¡œì íŠ¸ IDë¡œ ë³€ê²½ í•„ìš”
            
            const query = `
              query($projectId: ID!) {
                node(id: $projectId) {
                  ... on ProjectV2 {
                    title
                    items(first: 100) {
                      nodes {
                        id
                        content {
                          ... on DraftIssue {
                            title
                            body
                          }
                          ... on Issue {
                            title
                            number
                            url
                          }
                          ... on PullRequest {
                            title
                            number
                            url
                          }
                        }
                        fieldValues(first: 20) {
                          nodes {
                            ... on ProjectV2ItemFieldSingleSelectValue {
                              name
                              field {
                                ... on ProjectV2SingleSelectField {
                                  name
                                }
                              }
                            }
                            ... on ProjectV2ItemFieldTextValue {
                              text
                              field {
                                ... on ProjectV2FieldCommon {
                                  name
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;

            try {
              const result = await github.graphql(query, {
                projectId: PROJECT_ID
              });

              const project = result.node;
              const items = project.items.nodes;

              // í˜„ì¬ ìƒíƒœ êµ¬ì„±
              const currentState = {};
              items.forEach(item => {
                const title = item.content?.title || 'Untitled';
                const statusField = item.fieldValues.nodes.find(
                  field => field.field?.name === 'Status'
                );
                const status = statusField?.name || 'No Status';
                
                currentState[item.id] = {
                  title,
                  status,
                  url: item.content?.url || null
                };
              });

              // ì´ì „ ìƒíƒœ íŒŒì¼ ì½ê¸°
              let previousState = {};
              try {
                if (fs.existsSync('project-state.json')) {
                  previousState = JSON.parse(fs.readFileSync('project-state.json', 'utf8'));
                }
              } catch (error) {
                console.log('ì´ì „ ìƒíƒœ íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', error.message);
              }

              // ë³€ê²½ì‚¬í•­ ê°ì§€
              const changes = [];
              for (const [itemId, currentItem] of Object.entries(currentState)) {
                const previousItem = previousState[itemId];
                
                if (!previousItem) {
                  // ìƒˆë¡œìš´ í•­ëª©
                  changes.push({
                    type: 'new',
                    title: currentItem.title,
                    status: currentItem.status,
                    url: currentItem.url
                  });
                } else if (previousItem.status !== currentItem.status) {
                  // ìƒíƒœ ë³€ê²½
                  changes.push({
                    type: 'status_change',
                    title: currentItem.title,
                    oldStatus: previousItem.status,
                    newStatus: currentItem.status,
                    url: currentItem.url
                  });
                }
              }

              // ì‚­ì œëœ í•­ëª© í™•ì¸
              for (const [itemId, previousItem] of Object.entries(previousState)) {
                if (!currentState[itemId]) {
                  changes.push({
                    type: 'deleted',
                    title: previousItem.title,
                    status: previousItem.status
                  });
                }
              }

              // í˜„ì¬ ìƒíƒœ ì €ì¥
              fs.writeFileSync('project-state.json', JSON.stringify(currentState, null, 2));

              return { changes, hasChanges: changes.length > 0 };
            } catch (error) {
              console.error('í”„ë¡œì íŠ¸ ëª¨ë‹ˆí„°ë§ ì¤‘ ì˜¤ë¥˜:', error);
              return { changes: [], hasChanges: false, error: error.message };
            }

      - name: Send Discord Notifications
        if: fromJson(steps.monitor.outputs.result).hasChanges
        run: |
          CHANGES='${{ steps.monitor.outputs.result }}'
          
          echo "$CHANGES" | jq -r '.changes[] | @json' | while IFS= read -r change; do
            TYPE=$(echo "$change" | jq -r '.type')
            TITLE=$(echo "$change" | jq -r '.title')
            
            case "$TYPE" in
              "new")
                STATUS=$(echo "$change" | jq -r '.status')
                EMOJI="ğŸ†•"
                COLOR="3447003"  # íŒŒë‘
                DESCRIPTION="ìƒˆë¡œìš´ í•­ëª©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤: **$STATUS**"
                ;;
              "status_change")
                OLD_STATUS=$(echo "$change" | jq -r '.oldStatus')
                NEW_STATUS=$(echo "$change" | jq -r '.newStatus')
                EMOJI="ğŸ”„"
                case "$NEW_STATUS" in
                  "Done") COLOR="65280" ;;      # ì´ˆë¡
                  "In progress") COLOR="16776960" ;; # ë…¸ë‘
                  "Todo") COLOR="16711680" ;;   # ë¹¨ê°•
                  *) COLOR="8421504" ;;         # íšŒìƒ‰
                esac
                DESCRIPTION="ìƒíƒœê°€ **$OLD_STATUS** â†’ **$NEW_STATUS**ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤"
                ;;
              "deleted")
                EMOJI="ğŸ—‘ï¸"
                COLOR="8421504"  # íšŒìƒ‰
                DESCRIPTION="í•­ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤"
                ;;
            esac
            
            URL=$(echo "$change" | jq -r '.url // empty')
            URL_FIELD=""
            if [ "$URL" != "" ] && [ "$URL" != "null" ]; then
              URL_FIELD=", \"url\": \"$URL\""
            fi
            
            curl -H "Content-Type: application/json" \
                 -X POST \
                 -d "{
                   \"embeds\": [{
                     \"title\": \"$EMOJI $TITLE\",
                     \"description\": \"$DESCRIPTION\",
                     \"color\": $COLOR,
                     \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",
                     \"footer\": {
                       \"text\": \"GitHub Project Monitor\"
                     }$URL_FIELD
                   }]
                 }" \
                 ${{ secrets.DISCORD_WEBHOOK }}
            
            # API ìš”ì²­ ê°„ ì ì‹œ ëŒ€ê¸°
            sleep 1
          done

      - name: Commit state file
        run: |
          if [ -f "project-state.json" ]; then
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add project-state.json
            git diff --staged --quiet || git commit -m "Update project state"
            git push
          fi
