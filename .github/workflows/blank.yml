name: Discord Issue All Event Notifier

on:
  issues:
    types: [opened, edited, deleted, transferred, closed, reopened, assigned, unassigned, labeled, unlabeled, milestoned, demilestoned, locked, unlocked]

jobs:
  notify_discord:
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord Notification
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          ACTION: ${{ github.event.action }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_URL: ${{ github.event.issue.html_url }}
          SENDER_LOGIN: ${{ github.event.sender.login }}
          SENDER_AVATAR: ${{ github.event.sender.avatar_url }}
          REPO_NAME: ${{ github.repository }}
        run: |
          set -e
          
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "‚ùå Error: DISCORD_WEBHOOK_URL is not set"
            exit 1
          fi
          
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          case $ACTION in
            "opened") TITLE="üö® ÏÉàÎ°úÏö¥ Ïù¥Ïäà Î∞úÏÉù"; COLOR=16711680 ;;
            "closed") TITLE="‚úÖ Ïù¥Ïäà Ìï¥Í≤∞"; COLOR=65280 ;;
            "reopened") TITLE="‚ö†Ô∏è Ïù¥Ïäà Ïû¨Í∞ú"; COLOR=16761088 ;;
            "labeled") TITLE="üè∑Ô∏è ÎùºÎ≤® Ï∂îÍ∞Ä"; COLOR=4390561 ;;
            "unlabeled") TITLE="üè∑Ô∏è ÎùºÎ≤® Ï†úÍ±∞"; COLOR=4390561 ;;
            "assigned") TITLE="üë§ Îã¥ÎãπÏûê ÏßÄÏ†ï"; COLOR=4390561 ;;
            "unassigned") TITLE="üë§ Îã¥ÎãπÏûê Ìï¥Ï†ú"; COLOR=4390561 ;;
            "edited") TITLE="‚úèÔ∏è Ïù¥Ïäà ÎÇ¥Ïö© ÏàòÏ†ï"; COLOR=16776960 ;;
            "locked") TITLE="üîí Ïù¥Ïäà Ïû†Í∏à"; COLOR=4390561 ;;
            "unlocked") TITLE="üîì Ïù¥Ïäà Ïû†Í∏à Ìï¥Ï†ú"; COLOR=4390561 ;;
            "transferred") TITLE="üì§ Ïù¥Ïäà Ïù¥Ï†Ñ"; COLOR=4390561 ;;
            "milestoned") TITLE="üéØ ÎßàÏùºÏä§ÌÜ§ ÏÑ§Ï†ï"; COLOR=4390561 ;;
            "demilestoned") TITLE="üéØ ÎßàÏùºÏä§ÌÜ§ Ìï¥Ï†ú"; COLOR=4390561 ;;
            "deleted") TITLE="üóëÔ∏è Ïù¥Ïäà ÏÇ≠Ï†ú"; COLOR=8421504 ;;
            *) TITLE="‚öôÔ∏è Ïù¥Ïäà ÏóÖÎç∞Ïù¥Ìä∏"; COLOR=4390561 ;;
          esac
          
          # sender ÌïÑÎìúÎ•º ÏµúÏÉÅÏúÑÏóê Ï∂îÍ∞Ä
          jq -n \
            --arg username "$SENDER_LOGIN" \
            --arg avatar_url "$SENDER_AVATAR" \
            --arg sender "$SENDER_LOGIN" \
            --arg title "$TITLE" \
            --arg issue_title "${ISSUE_TITLE:-Ï†úÎ™© ÏóÜÏùå}" \
            --arg issue_number "$ISSUE_NUMBER" \
            --arg action "$ACTION" \
            --arg url "$ISSUE_URL" \
            --arg repo "$REPO_NAME" \
            --argjson color "$COLOR" \
            --arg timestamp "$TIMESTAMP" \
            '{
              username: $username,
              avatar_url: $avatar_url,
              sender: $sender,
              embeds: [{
                title: $title,
                description: $issue_title,
                color: $color,
                timestamp: $timestamp,
                fields: [
                  {
                    name: "Ïù¥Ïäà Î≤àÌò∏",
                    value: ("#" + $issue_number),
                    inline: true
                  },
                  {
                    name: "Ïï°ÏÖò",
                    value: $action,
                    inline: true
                  },
                  {
                    name: "Ï≤òÎ¶¨Ïûê",
                    value: $sender,
                    inline: true
                  },
                  {
                    name: "Ï†ÄÏû•ÏÜå",
                    value: $repo,
                    inline: false
                  }
                ],
                url: $url
              }]
            }' > payload.json
          
          echo "üì§ Sending payload:"
          cat payload.json
          
          HTTP_RESPONSE=$(curl -X POST \
            -H "Content-Type: application/json" \
            -d @payload.json \
            -w "\n%{http_code}" \
            -s \
            "$DISCORD_WEBHOOK_URL")
          
          HTTP_STATUS=$(echo "$HTTP_RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$HTTP_RESPONSE" | head -n-1)
          
          if [ "$HTTP_STATUS" -ge 200 ] && [ "$HTTP_STATUS" -lt 300 ]; then
            echo "‚úÖ Discord notification sent successfully (HTTP $HTTP_STATUS)"
          else
            echo "‚ùå Failed to send Discord notification (HTTP $HTTP_STATUS)"
            echo "Response: $RESPONSE_BODY"
            exit 1
          finame: Discord Issue All Event Notifier

on:
  issues:
    types: [opened, edited, deleted, transferred, closed, reopened, assigned, unassigned, labeled, unlabeled, milestoned, demilestoned, locked, unlocked]

jobs:
  notify_discord:
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord Notification
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          ACTION: ${{ github.event.action }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_URL: ${{ github.event.issue.html_url }}
          SENDER_LOGIN: ${{ github.event.sender.login }}
          SENDER_AVATAR: ${{ github.event.sender.avatar_url }}
          REPO_NAME: ${{ github.repository }}
        run: |
          set -e
          
          # Webhook URL Í≤ÄÏ¶ù
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "‚ùå Error: DISCORD_WEBHOOK_URL is not set"
            exit 1
          fi
          
          # ÌòÑÏû¨ ÏãúÍ∞ÑÏùÑ ISO 8601 ÌòïÏãùÏúºÎ°ú ÏÉùÏÑ±
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          # ÏÉÅÌô©Ïóê ÎßûÎäî Ï†úÎ™©Í≥º ÏÉâÏÉÅ ÏÑ§Ï†ï
          case $ACTION in
            "opened") TITLE="üö® ÏÉàÎ°úÏö¥ Ïù¥Ïäà Î∞úÏÉù"; COLOR=16711680 ;;
            "closed") TITLE="‚úÖ Ïù¥Ïäà Ìï¥Í≤∞"; COLOR=65280 ;;
            "reopened") TITLE="‚ö†Ô∏è Ïù¥Ïäà Ïû¨Í∞ú"; COLOR=16761088 ;;
            "labeled") TITLE="üè∑Ô∏è ÎùºÎ≤® Ï∂îÍ∞Ä"; COLOR=4390561 ;;
            "unlabeled") TITLE="üè∑Ô∏è ÎùºÎ≤® Ï†úÍ±∞"; COLOR=4390561 ;;
            "assigned") TITLE="üë§ Îã¥ÎãπÏûê ÏßÄÏ†ï"; COLOR=4390561 ;;
            "unassigned") TITLE="üë§ Îã¥ÎãπÏûê Ìï¥Ï†ú"; COLOR=4390561 ;;
            "edited") TITLE="‚úèÔ∏è Ïù¥Ïäà ÎÇ¥Ïö© ÏàòÏ†ï"; COLOR=16776960 ;;
            "locked") TITLE="üîí Ïù¥Ïäà Ïû†Í∏à"; COLOR=4390561 ;;
            "unlocked") TITLE="üîì Ïù¥Ïäà Ïû†Í∏à Ìï¥Ï†ú"; COLOR=4390561 ;;
            "transferred") TITLE="üì§ Ïù¥Ïäà Ïù¥Ï†Ñ"; COLOR=4390561 ;;
            "milestoned") TITLE="üéØ ÎßàÏùºÏä§ÌÜ§ ÏÑ§Ï†ï"; COLOR=4390561 ;;
            "demilestoned") TITLE="üéØ ÎßàÏùºÏä§ÌÜ§ Ìï¥Ï†ú"; COLOR=4390561 ;;
            "deleted") TITLE="üóëÔ∏è Ïù¥Ïäà ÏÇ≠Ï†ú"; COLOR=8421504 ;;
            *) TITLE="‚öôÔ∏è Ïù¥Ïäà ÏóÖÎç∞Ïù¥Ìä∏"; COLOR=4390561 ;;
          esac
          
          # JSON ÏÉùÏÑ± Î∞è Ï†ÑÏÜ°
          jq -n \
            --arg username "$SENDER_LOGIN" \
            --arg avatar_url "$SENDER_AVATAR" \
            --arg title "$TITLE" \
            --arg issue_title "${ISSUE_TITLE:-Ï†úÎ™© ÏóÜÏùå}" \
            --arg issue_number "$ISSUE_NUMBER" \
            --arg action "$ACTION" \
            --arg sender "$SENDER_LOGIN" \
            --arg url "$ISSUE_URL" \
            --arg repo "$REPO_NAME" \
            --argjson color "$COLOR" \
            --arg timestamp "$TIMESTAMP" \
            '{
              username: $username,
              avatar_url: $avatar_url,
              embeds: [{
                title: $title,
                description: $issue_title,
                color: $color,
                timestamp: $timestamp,
                fields: [
                  {
                    name: "Ïù¥Ïäà Î≤àÌò∏",
                    value: ("#" + $issue_number),
                    inline: true
                  },
                  {
                    name: "Ïï°ÏÖò",
                    value: $action,
                    inline: true
                  },
                  {
                    name: "Ï≤òÎ¶¨Ïûê",
                    value: $sender,
                    inline: true
                  },
                  {
                    name: "Ï†ÄÏû•ÏÜå",
                    value: $repo,
                    inline: false
                  }
                ],
                url: $url
              }]
            }' > payload.json
          
          # ÎîîÎ≤ÑÍπÖ: payload Ï∂úÎ†•
          echo "üì§ Sending payload:"
          cat payload.json
          
          # DiscordÎ°ú Ï†ÑÏÜ°
          HTTP_RESPONSE=$(curl -X POST \
            -H "Content-Type: application/json" \
            -d @payload.json \
            -w "\n%{http_code}" \
            -s \
            "$DISCORD_WEBHOOK_URL")
          
          HTTP_STATUS=$(echo "$HTTP_RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$HTTP_RESPONSE" | head -n-1)
          
          # ÏùëÎãµ ÌôïÏù∏
          if [ "$HTTP_STATUS" -ge 200 ] && [ "$HTTP_STATUS" -lt 300 ]; then
            echo "‚úÖ Discord notification sent successfully (HTTP $HTTP_STATUS)"
          else
            echo "‚ùå Failed to send Discord notification (HTTP $HTTP_STATUS)"
            echo "Response: $RESPONSE_BODY"
            exit 1
          fi
