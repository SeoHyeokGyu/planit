name: Discord Projects Status Change

on:
  issues:
    types: [edited, labeled, unlabeled]

jobs:
  detect-status-change:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout for state storage
        uses: actions/checkout@v4
        with:
          sparse-checkout: .github/project-state
          
      - name: Get Current Project Status
        id: current
        env:
          GITHUB_TOKEN: ${{ secrets.PROJECT_TOKEN }}
          ISSUE_NODE_ID: ${{ github.event.issue.node_id }}
        run: |
          QUERY='query($nodeId: ID!) {
            node(id: $nodeId) {
              ... on Issue {
                number
                projectItems(first: 10) {
                  nodes {
                    id
                    project {
                      number
                      title
                    }
                    fieldValues(first: 10) {
                      nodes {
                        ... on ProjectV2ItemFieldSingleSelectValue {
                          name
                          field {
                            ... on ProjectV2SingleSelectField {
                              name
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          }'
          
          RESPONSE=$(gh api graphql -f query="$QUERY" -f nodeId="$ISSUE_NODE_ID")
          
          STATUS=$(echo "$RESPONSE" | jq -r '
            .data.node.projectItems.nodes[]? |
            select(.project.number == 2) |
            .fieldValues.nodes[]? |
            select(.field.name == "Status") |
            .name // "None"
          ' | head -n1)
          
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "Current status: $STATUS"
          
      - name: Load Previous Status
        id: previous
        continue-on-error: true
        run: |
          ISSUE_NUM="${{ github.event.issue.number }}"
          STATE_FILE=".github/project-state/issue-${ISSUE_NUM}.txt"
          
          if [ -f "$STATE_FILE" ]; then
            PREV_STATUS=$(cat "$STATE_FILE")
            echo "status=$PREV_STATUS" >> $GITHUB_OUTPUT
            echo "Previous status: $PREV_STATUS"
          else
            echo "status=None" >> $GITHUB_OUTPUT
            echo "No previous status found"
          fi
          
      - name: Detect Status Change
        id: change
        run: |
          CURRENT="${{ steps.current.outputs.status }}"
          PREVIOUS="${{ steps.previous.outputs.status }}"
          
          if [ "$CURRENT" != "$PREVIOUS" ] && [ "$CURRENT" != "None" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Status changed: $PREVIOUS â†’ $CURRENT"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Send Discord Notification
        if: steps.change.outputs.changed == 'true'
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          CURRENT="${{ steps.current.outputs.status }}"
          PREVIOUS="${{ steps.previous.outputs.status }}"
          ISSUE_NUM="${{ github.event.issue.number }}"
          TITLE="${{ github.event.issue.title }}"
          URL="${{ github.event.issue.html_url }}"
          USER="${{ github.event.sender.login }}"
          
          # ìƒíƒœë³„ ì´ëª¨ì§€ì™€ ìƒ‰ìƒ
          case $CURRENT in
            "Todo")
              EMOJI="ðŸ“‹"
              COLOR=11184810
              ;;
            "In Progress")
              EMOJI="ðŸ”„"
              COLOR=16776960
              ;;
            "Done")
              EMOJI="âœ…"
              COLOR=3066993
              ;;
            *)
              EMOJI="ðŸ“Œ"
              COLOR=5814783
              ;;
          esac
          
          if [ "$PREVIOUS" == "None" ]; then
            DESCRIPTION="**$TITLE**\n\nâž• **$CURRENT** ìƒíƒœë¡œ ì¶”ê°€ë¨"
          else
            DESCRIPTION="**$TITLE**\n\n$PREVIOUS âž¡ï¸ **$CURRENT**"
          fi
          
          curl -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"username\": \"GitHub Projects\",
              \"embeds\": [{
                \"title\": \"$EMOJI í”„ë¡œì íŠ¸ ìƒíƒœ ë³€ê²½ #$ISSUE_NUM\",
                \"description\": \"$DESCRIPTION\",
                \"url\": \"$URL\",
                \"color\": $COLOR,
                \"footer\": {\"text\": \"$USER\"},
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }"
          
      - name: Save Current Status
        run: |
          ISSUE_NUM="${{ github.event.issue.number }}"
          CURRENT="${{ steps.current.outputs.status }}"
          STATE_DIR=".github/project-state"
          STATE_FILE="$STATE_DIR/issue-${ISSUE_NUM}.txt"
          
          mkdir -p "$STATE_DIR"
          echo "$CURRENT" > "$STATE_FILE"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "$STATE_FILE"
          git diff --quiet && git diff --staged --quiet || git commit -m "Update project status for issue #$ISSUE_NUM"
          git push || echo "No changes to push"
