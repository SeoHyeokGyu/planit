name: Discord Issue All Event Notifier

on:
  issues:
    types: [opened, edited, deleted, transferred, closed, reopened, assigned, unassigned, labeled, unlabeled, milestoned, demilestoned, locked, unlocked]

jobs:
  notify_discord:
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord Notification
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          ACTION: ${{ github.event.action }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_URL: ${{ github.event.issue.html_url }}
          SENDER_LOGIN: ${{ github.event.sender.login }}
          UPDATED_AT: ${{ github.event.issue.updated_at }}
        run: |
          set -e  # ì—ëŸ¬ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¢…ë£Œ
          
          # Webhook URL ê²€ì¦
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "âŒ Error: DISCORD_WEBHOOK_URL is not set"
            exit 1
          fi
          
          # ìƒí™©ì— ë§ëŠ” ì œëª©ê³¼ ìƒ‰ìƒ ì„¤ì •
          case $ACTION in
            "opened") TITLE="ğŸš¨ ìƒˆë¡œìš´ ì´ìŠˆ ë°œìƒ: #$ISSUE_NUMBER"; COLOR=16711680 ;;
            "closed") TITLE="âœ… ì´ìŠˆ í•´ê²°: #$ISSUE_NUMBER"; COLOR=65280 ;;
            "reopened") TITLE="âš ï¸ ì´ìŠˆ ì¬ê°œ: #$ISSUE_NUMBER"; COLOR=16761088 ;;
            "labeled") TITLE="ğŸ·ï¸ ë¼ë²¨ ì¶”ê°€: #$ISSUE_NUMBER"; COLOR=4390561 ;;
            "unlabeled") TITLE="ğŸ·ï¸ ë¼ë²¨ ì œê±°: #$ISSUE_NUMBER"; COLOR=4390561 ;;
            "assigned") TITLE="ğŸ‘¤ ë‹´ë‹¹ì ì§€ì •: #$ISSUE_NUMBER"; COLOR=4390561 ;;
            "unassigned") TITLE="ğŸ‘¤ ë‹´ë‹¹ì í•´ì œ: #$ISSUE_NUMBER"; COLOR=4390561 ;;
            "edited") TITLE="âœï¸ ì´ìŠˆ ë‚´ìš© ìˆ˜ì •: #$ISSUE_NUMBER"; COLOR=16776960 ;;
            "locked") TITLE="ğŸ”’ ì´ìŠˆ ì ê¸ˆ: #$ISSUE_NUMBER"; COLOR=4390561 ;;
            "unlocked") TITLE="ğŸ”“ ì´ìŠˆ ì ê¸ˆ í•´ì œ: #$ISSUE_NUMBER"; COLOR=4390561 ;;
            "transferred") TITLE="ğŸ“¤ ì´ìŠˆ ì´ì „: #$ISSUE_NUMBER"; COLOR=4390561 ;;
            "milestoned") TITLE="ğŸ¯ ë§ˆì¼ìŠ¤í†¤ ì„¤ì •: #$ISSUE_NUMBER"; COLOR=4390561 ;;
            "demilestoned") TITLE="ğŸ¯ ë§ˆì¼ìŠ¤í†¤ í•´ì œ: #$ISSUE_NUMBER"; COLOR=4390561 ;;
            *) TITLE="âš™ï¸ ì´ìŠˆ ì—…ë°ì´íŠ¸: #$ISSUE_NUMBER"; COLOR=4390561 ;;
          esac
          
          # ì„¤ëª… í…ìŠ¤íŠ¸ ì¤€ë¹„ (íŠ¹ìˆ˜ë¬¸ì ì´ìŠ¤ì¼€ì´í”„ëŠ” jqê°€ ìë™ ì²˜ë¦¬)
          DESCRIPTION=$(printf '**ì•¡ì…˜:** %s\n**ì œëª©:** %s\n**ì²˜ë¦¬ì:** %s\n\n[ì´ìŠˆ ë°”ë¡œê°€ê¸°](%s)' \
            "$ACTION" \
            "${ISSUE_TITLE:-ì œëª© ì—†ìŒ}" \
            "${SENDER_LOGIN:-ì•Œ ìˆ˜ ì—†ìŒ}" \
            "$ISSUE_URL")
          
          # JSON ìƒì„± ë° Discordë¡œ ì „ì†¡
          HTTP_STATUS=$(jq -n \
            --arg title "$TITLE" \
            --arg description "$DESCRIPTION" \
            --argjson color "$COLOR" \
            --arg timestamp "$UPDATED_AT" \
            '{
              embeds: [{
                title: $title,
                description: $description,
                color: $color,
                timestamp: $timestamp
              }]
            }' | \
            curl -X POST \
              -H "Content-Type: application/json" \
              -d @- \
              -w "%{http_code}" \
              -o /dev/null \
              -s \
              "$DISCORD_WEBHOOK_URL")
          
          # HTTP ì‘ë‹µ ì½”ë“œ í™•ì¸
          if [ "$HTTP_STATUS" -ge 200 ] && [ "$HTTP_STATUS" -lt 300 ]; then
            echo "âœ… Discord notification sent successfully (HTTP $HTTP_STATUS)"
          else
            echo "âŒ Failed to send Discord notification (HTTP $HTTP_STATUS)"
            exit 1
          fi
