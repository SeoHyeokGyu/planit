name: Discord Projects V2 Notifier

on:
  issues:
    types: [opened, closed, reopened, assigned, unassigned, labeled, unlabeled]
  # Issueê°€ ìˆ˜ì •ë  ë•Œë„ ê°ì§€í•˜ë ¤ë©´:
  # issue_comment:
  #   types: [created]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Get Project Status
        id: project_status
        env:
          GITHUB_TOKEN: ${{ secrets.PROJECT_TOKEN }}
          ISSUE_NODE_ID: ${{ github.event.issue.node_id }}
          PROJECT_NUMBER: 2
          OWNER: SeoHyeokGyu
        run: |
          # GraphQLë¡œ Issueì˜ í˜„ì¬ Project ìƒíƒœ ì¡°íšŒ
          QUERY=$(cat <<'GQL'
          query($nodeId: ID!, $owner: String!, $number: Int!) {
            node(id: $nodeId) {
              ... on Issue {
                projectItems(first: 10) {
                  nodes {
                    project {
                      number
                      title
                    }
                    fieldValues(first: 10) {
                      nodes {
                        ... on ProjectV2ItemFieldSingleSelectValue {
                          name
                          field {
                            ... on ProjectV2SingleSelectField {
                              name
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          }
          GQL
          )
          
          RESPONSE=$(gh api graphql \
            -f query="$QUERY" \
            -f nodeId="$ISSUE_NODE_ID" \
            -f owner="$OWNER" \
            -F number=$PROJECT_NUMBER)
          
          echo "Response: $RESPONSE"
          
          # Status í•„ë“œ ì¶”ì¶œ
          STATUS=$(echo "$RESPONSE" | jq -r '
            .data.node.projectItems.nodes[]? |
            select(.project.number == 2) |
            .fieldValues.nodes[]? |
            select(.field.name == "Status") |
            .name // "Unknown"
          ' | head -n1)
          
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "Current Status: $STATUS"
      
      - name: Send Discord Notification
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          PROJECT_STATUS: ${{ steps.project_status.outputs.status }}
        run: |
          ACTION="${{ github.event.action }}"
          ISSUE_NUM="${{ github.event.issue.number }}"
          TITLE="${{ github.event.issue.title }}"
          URL="${{ github.event.issue.html_url }}"
          USER="${{ github.event.sender.login }}"
          REPO="${{ github.repository }}"
          
          # ê¸°ë³¸ ì´ë²¤íŠ¸ ì²˜ë¦¬
          case $ACTION in
            "opened")
              EMOJI="ğŸš¨"
              MSG="ìƒˆ ì´ìŠˆ ìƒì„±"
              COLOR=15158332
              ;;
            "closed")
              EMOJI="âœ…"
              MSG="ì´ìŠˆ í•´ê²°"
              COLOR=3066993
              ;;
            "reopened")
              EMOJI="ğŸ”„"
              MSG="ì´ìŠˆ ì¬ê°œ"
              COLOR=15105570
              ;;
            "assigned")
              EMOJI="ğŸ‘¤"
              MSG="ë‹´ë‹¹ì ì§€ì •"
              COLOR=5763719
              ;;
            "unassigned")
              EMOJI="ğŸ‘¤"
              MSG="ë‹´ë‹¹ì í•´ì œ"
              COLOR=9807270
              ;;
            "labeled")
              LABEL="${{ github.event.label.name }}"
              EMOJI="ğŸ·ï¸"
              MSG="ë¼ë²¨ ì¶”ê°€: $LABEL"
              COLOR=3447003
              ;;
            "unlabeled")
              LABEL="${{ github.event.label.name }}"
              EMOJI="ğŸ·ï¸"
              MSG="ë¼ë²¨ ì œê±°: $LABEL"
              COLOR=10070709
              ;;
            *)
              exit 0
              ;;
          esac
          
          # Projects ìƒíƒœ ì •ë³´ ì¶”ê°€
          if [ -n "$PROJECT_STATUS" ] && [ "$PROJECT_STATUS" != "Unknown" ] && [ "$PROJECT_STATUS" != "null" ]; then
            STATUS_FIELD=",{\"name\": \"ğŸ“Š í”„ë¡œì íŠ¸ ìƒíƒœ\", \"value\": \"$PROJECT_STATUS\", \"inline\": true}"
          else
            STATUS_FIELD=""
          fi
          
          # Discord ì „ì†¡
          curl -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"username\": \"GitHub\",
              \"avatar_url\": \"https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png\",
              \"embeds\": [{
                \"title\": \"$EMOJI $MSG #$ISSUE_NUM\",
                \"description\": \"**$TITLE**\",
                \"url\": \"$URL\",
                \"color\": $COLOR,
                \"fields\": [
                  {
                    \"name\": \"ğŸ“ ì €ì¥ì†Œ\",
                    \"value\": \"$REPO\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"ğŸ‘¤ ì‘ì—…ì\",
                    \"value\": \"$USER\",
                    \"inline\": true
                  }
                  $STATUS_FIELD
                ],
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }"
